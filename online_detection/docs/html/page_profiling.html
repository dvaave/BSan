<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
<title>DynamoRIO: Profiling DynamoRIO and Clients</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page_profiling.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Profiling DynamoRIO and Clients </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md220"></a>
Linux</h1>
<h2><a class="anchor" id="autotoc_md221"></a>
DynamoRIO PC self-sampling</h2>
<p>The client can use <a class="el" href="dr__tools_8h.html#ac74de1da117d9c807b986aeda2523dd9">dr_set_itimer()</a> for programmatic PC self-sampling, with <a class="el" href="dr__tools_8h.html#a9333e0dee46cc854228efab156ce98c5">dr_where_am_i()</a> providing information on where the sample was taken. This provides general categorization of where time is being spent in the overall instrumentation system, with potential to drill down further offline based on the PC.</p>
<p>For PC sampling via DR's <code>-prof_pcs</code> runtime option instead, that is available internally in varying degrees on different platforms but is not polished enough and is missing some pieces (see the bottom of this page).</p>
<h2><a class="anchor" id="autotoc_md222"></a>
External sampling tools</h2>
<p>Perf and oprofile are the two prominent sampling profilers on Linux today. Perf is newer and has a nicer interface, but it requires patching and building from source in order to get symbols for DR. oprofile is typically available on older distros, but it's not available on Ubuntu Precise, it seems to cause system lockups, and we're not sure we trust the results.</p>
<p>Before doing any micro-optimization based on the profile, make sure to disable CPU frequency scaling before taking measurements: </p><div class="fragment"><div class="line"><span class="keywordflow">for</span> N in /sys/devices/system/cpu/cpu[; <span class="keywordflow">do</span> echo performance | sudo tee $N/cpufreq/scaling_governor ; done</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md223"></a>
oprofile</h3>
<p>To install oprofile, type: </p><div class="fragment"><div class="line"><span class="preprocessor"># Or other distro command</span></div>
<div class="line">sudo apt-get install oprofile</div>
<div class="line"><span class="preprocessor"># We don&#39;t need to profile the kernel</span></div>
<div class="line"><span class="preprocessor">sudo /usr/bin/opcontrol --no-vmlinux</span></div>
</div><!-- fragment --><p>To make sudo opcontrol work w/o a password, type <code>sudo visudo</code> and add one line to the <code>/etc/sudoers</code> file: </p><div class="fragment"><div class="line">your_username ALL=NOPASSWD: /usr/bin/opcontrol</div>
</div><!-- fragment --><p>To run oprofile, you can use a script like the following to start and stop it around the command you wish to run: </p><div class="fragment"><div class="line">sudo opcontrol --shutdown || <span class="keyword">true</span>  # Shutdown existing oprofile daemon, <span class="keywordflow">if</span> any</div>
<div class="line">sudo opcontrol --reset  # Throw away previously collected data</div>
<div class="line">sudo opcontrol -c 0  # Replace 0 with N <span class="keywordflow">if</span> you need callgraph</div>
<div class="line">sudo opcontrol --start</div>
<div class="line">your_command_here</div>
<div class="line">sudo opcontrol --stop</div>
<div class="line">sudo opcontrol --dump  # Dumps data into local file</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Now get the report:</span></div>
<div class="line">opreport -t 1 -l object_file_to_get_stats_for</div>
<div class="line"><span class="preprocessor"># or to get the callgraph (don&#39;t forget to -c N above!)</span></div>
<div class="line"><span class="preprocessor">opreport -c -l object_file_to_get_stats_for</span></div>
</div><!-- fragment --><p>Example report output: </p><div class="fragment"><div class="line">[rnk@wittenberg src](0-9])$ opreport -t 2 -l ../../dynamorio/build/install/lib64/release/libdynamorio.so.3.2</div>
<div class="line">...</div>
<div class="line">samples  %        symbol name</div>
<div class="line">4971      7.1208  insert_exit_stub_other_flags</div>
<div class="line">2107      3.0182  mutex_lock</div>
<div class="line">2082      2.9824  <a class="code" href="dr__ir__decode_8h.html#af4a2c830c95757037eaa1a192a22aa3a">decode_sizeof</a></div>
<div class="line">1774      2.5412  build_bb_ilist</div>
<div class="line">1695      2.4280  encoding_possible_pass</div>
<div class="line">1653      2.3679  fragment_lookup_fine_and_coarse</div>
<div class="line">1647      2.3593  instr_encode_common</div>
<div class="line">1502      2.1516  dispatch</div>
<div class="line">1399      2.0040  hashtable_fragment_lookup</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md224"></a>
perf</h3>
<p>Perf currently does not handle symbols in DSOs that have a preferred base, and they only recently added support for following .gnu_debuglink. Since profiling without symbols isn't very useful, the following instructions are for building perf from source with a patch I wrote to fix the problem.</p>
<p>The patch to get good symbols with perf is available here: <a href="https://github.com/rnk/linux/compare/perf-p_vaddr.diff">https://github.com/rnk/linux/compare/perf-p_vaddr.diff</a></p>
<p>You can clone the entire branch, or you can apply the patch to some other copy of the Linux kernel source. Either way, cd into tools/perf and run 'make' to build just perf. It will warn you about each library or header that it can't find, and you can install the appropriate package.</p>
<p>Running 'make install' as a normal user will install to $HOME/bin and $HOME/libexec.</p>
<p>To do a run and get a report, it's quite simple: </p><div class="fragment"><div class="line">perf record your_command  # Stores result in cwd/perf.data</div>
<div class="line">perf report</div>
</div><!-- fragment --><p>Example output: </p><div class="fragment"><div class="line">[src](rnk@wittenberg)$ perf report | head</div>
<div class="line"># Overhead         Command        Shared Object                                                                       Symbol</div>
<div class="line"># ........  ..............  ...................  ...........................................................................</div>
<div class="line">#</div>
<div class="line">    17.68%  DumpRenderTree  perf-14440.map       [0x0000000071c59213</div>
<div class="line">     5.14%  DumpRenderTree  libdynamorio.so.3.2  [.](.]) insert_exit_stub_other_flags</div>
<div class="line">     4.51%  DumpRenderTree  libdynamorio.so.3.2  [hashtable_fragment_lookup.isra.31</div>
<div class="line">     2.27%  DumpRenderTree  libdynamorio.so.3.2  [.](.]) mutex_lock</div>
<div class="line">     1.94%  DumpRenderTree  libdynamorio.so.3.2  [build_bb_ilist</div>
<div class="line">     1.92%  DumpRenderTree  libdynamorio.so.3.2  [.](.]) encoding_possible_pass</div>
</div><!-- fragment --><p>The perf-NNN.map DSO corresponds to DR's code cache. As you can see from above, at the time of writing, stub updating is a hotspot. You can focus in on just DR by passing "-d libdynamorio.3.2".</p>
<p>To get a combined source and asm annotation, you can use "perf annotate -s insert_exit_stub_other_flags". Example output: </p><div class="fragment"><div class="line">...</div>
<div class="line">                                                                                                                                               ▒</div>
<div class="line">       │     <span class="keywordtype">byte</span> *                                                                                                                                                                                         ▒</div>
<div class="line">       │     insert_relative_jump(<span class="keywordtype">byte</span> *pc, cache_pc target, <span class="keywordtype">bool</span> hot_patch)                                                                                                                                ▒</div>
<div class="line">       │     {                                                                                                                                                                                              ▒</div>
<div class="line">       │         ASSERT(pc != NULL);                                                                                                                                                                        ▒</div>
<div class="line">       │         **pc = JMP_OPCODE;                                                                                                                                                                          ▒</div>
<div class="line">       │         pc++;                                                                                                                                                                                      ◆</div>
<div class="line">  0.24 │ dc:   lea    0x1(%rax),%rdx                                                                                                                                                                        ▒</div>
<div class="line">       │                                                                                                                                                                                                    ▒</div>
<div class="line">       │     <span class="keywordtype">byte</span> **                                                                                                                                                                                         ▒</div>
<div class="line">       │     insert_relative_jump(<span class="keywordtype">byte</span> *pc, cache_pc target, <span class="keywordtype">bool</span> hot_patch)                                                                                                                                ▒</div>
<div class="line">       │     {                                                                                                                                                                                              ▒</div>
<div class="line">       │         ASSERT(pc != NULL);                                                                                                                                                                        ▒</div>
<div class="line">       │         **pc = JMP_OPCODE;                                                                                                                                                                          ▒</div>
<div class="line">  0.16 │       movb   $0xe9,(%rax)                                                                                                                                                                          ▒</div>
<div class="line">       │     <span class="keywordtype">byte</span> **                                                                                                                                                                                         ▒</div>
<div class="line">       │     insert_relative_target(<span class="keywordtype">byte</span> **pc, cache_pc target, <span class="keywordtype">bool</span> hot_patch)                                                                                                                              ▒</div>
<div class="line">       │     {                                                                                                                                                                                              ▒</div>
<div class="line">       │                                                                                                                                                                                                 ▒</div>
<div class="line">       │         <span class="keywordtype">int</span> value = (int)(ptr_int_t)(target - pc - 4);                                                                                                                                             ▒</div>
<div class="line">  0.16 │       sub    %rdx,%r14                                                                                                                                                                             ▒</div>
<div class="line">       │       sub    $0x4,%r14d                                                                                                                                                                            ▒</div>
<div class="line">       │         IF_X64(ASSERT(CHECK_TRUNCATE_TYPE_int(target - pc - 4)));                                                                                                                                  ▒</div>
<div class="line">       │         ATOMIC_4BYTE_WRITE(pc, value, hot_patch);                                                                                                                                                  ▒</div>
<div class="line">       │       xchg   %r14d,(%rdx)                                                                                                                                                                          ▒</div>
<div class="line">       │                 **((ptr_uint_t **)pc) = (ptr_uint_t)l; pc += <span class="keyword">sizeof</span>(l);                                                                                                                              ▒</div>
<div class="line">       │     #ifdef X64                                                                                                                                                                                     ▒</div>
<div class="line">       │             }                                                                                                                                                                                      ▒</div>
<div class="line">       │     #endif                                                                                                                                                                                         ▒</div>
<div class="line">       │                                                                                                                                                                            ▒</div>
<div class="line">       │             pc = insert_relative_jump(pc, exit_target, NOT_HOT_PATCHABLE);                                                                                                                         ▒</div>
<div class="line"> 97.40 │       add    $0x5,%rax</div>
</div><!-- fragment --><p>97% of the samples in this function were on "add $0x5, %rax", which is misleading. The expensive instruction is more likely the "xchgl %r14d, (%rdx)" before it, which instruction we use to atomically update the code cache. In this particular case, we happen to be emitting the full exit stub, so it's unlikely that this needs to be an atomic update.</p>
<h1><a class="anchor" id="autotoc_md225"></a>
Windows</h1>
<p>We've used Code Analyst successfully.</p>
<p>TODO, more detail.</p>
<h1><a class="anchor" id="autotoc_md226"></a>
Cross-platform -prof_pcs</h1>
<p>There are many open issues for cleaning this up, such as <a href="https://github.com/DynamoRIO/dynamorio/issues#issue/140">issue 140</a>, <a href="https://github.com/DynamoRIO/dynamorio/issues#issue/359">issue 359</a>, <a href="https://github.com/DynamoRIO/dynamorio/issues#issue/767">issue 767</a>. On Linux the <a class="el" href="dr__tools_8h.html#ac74de1da117d9c807b986aeda2523dd9">dr_set_itimer()</a> solution above provides programmatic support. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="adr__ir__decode_8h_html_af4a2c830c95757037eaa1a192a22aa3a"><div class="ttname"><a href="dr__ir__decode_8h.html#af4a2c830c95757037eaa1a192a22aa3a">decode_sizeof</a></div><div class="ttdeci">DR_API int decode_sizeof(void *drcontext, byte *pc, int *num_prefixes _IF_X86_64(uint *rip_rel_pos))</div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:04:10 &nbsp; <img border=0 src="favicon.png">
</small></address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>
