<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
<title>DynamoRIO: Tool Event Model and API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('using.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Tool Event Model and API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This section gives an overview of how to use DynamoRIO, divided into the following sub-sections:</p>
<ul>
<li><a class="el" href="using.html#sec_events">Common Events</a></li>
<li><a class="el" href="using.html#sec_utils">Common Utilities</a></li>
<li><a class="el" href="using.html#sec_extlibs">Using External Libraries</a></li>
<li><a class="el" href="using.html#sec_extensions">DynamoRIO Extension Libraries</a></li>
<li><a class="el" href="using.html#sec_comm">Communication</a></li>
<li><a class="el" href="using.html#sec_annotations">Annotations</a></li>
<li><a class="el" href="using.html#sec_64bit_reach">64-Bit Reachability</a></li>
<li><a class="el" href="using.html#sec_utf8">String Encoding</a></li>
</ul>
<p>DynamoRIO exports a rich Application Programming Interface (API) to the user for building a DynamoRIO <em>client</em>. A DynamoRIO client is a library that is coupled with DynamoRIO in order to jointly operate on an input program binary:</p>
<div class="image">
<img src="client.png" alt=""/>
</div>
  <p>To interact with the client, DynamoRIO provides specific events that a client can intercept. Event interception functions, if supplied by a user client, are called by DynamoRIO at appropriate times.</p>
<p>DynamoRIO can alternatively be used as a third-party disassembly library (see <a class="el" href="page_standalone.html">Disassembly Library</a>).</p>
<h1><a class="anchor" id="sec_events"></a>
Common Events</h1>
<p>A client's primary interaction with the DynamoRIO system is via a set of event callbacks. These events include the following:</p>
<ul>
<li>Basic block and trace creation or deletion (<a class="el" href="dr__events_8h.html#acbfe1ece2c520d409ffd59076507a710">dr_register_bb_event()</a>, <a class="el" href="dr__events_8h.html#ad47842a864b5d406e56d6ceddbab47ac">dr_register_trace_event()</a>, <a class="el" href="dr__events_8h.html#a94ddb3474f89f5fb63b726ac9edaf08e">dr_register_delete_event()</a>)</li>
<li>Process initialization and exit (<a class="el" href="dr__api_8h.html#a2b938c98dd186cc94eef6880f9e3c3e9">dr_client_main()</a>, <a class="el" href="dr__events_8h.html#a32f38cabf4b2c554ce4e476c5d5f6f3a">dr_register_exit_event()</a>)</li>
<li>Thread initialization and exit (<a class="el" href="dr__events_8h.html#a92ad96993c826232e76a56ff43cd31d0">dr_register_thread_init_event()</a>, <a class="el" href="dr__events_8h.html#aa34d296a9e990925a096501a7d5c6596">dr_register_thread_exit_event()</a>)</li>
<li>Fork child initialization (Linux-only); meant to be used for re-initialization of data structures and creation of new log files (<a class="el" href="dr__events_8h.html#a606c6b8b2118f5d863fdb7a2a9e013d1">dr_register_fork_init_event()</a>)</li>
<li>Application library load and unload (<a class="el" href="dr__events_8h.html#a004acbc467ec57cd62be8c49d57a6928">dr_register_module_load_event()</a>, <a class="el" href="dr__events_8h.html#a1f11f7dd3d5509289049a8f996a60ca1">dr_register_module_unload_event()</a>)</li>
<li>Application fault or exception (signal on Linux) (<a class="el" href="dr__events_8h.html#a36fc1b4f973393d861c7740cda6c0002">dr_register_exception_event()</a>, <a class="el" href="dr__events_8h.html#a8f0c200ef1c92ac8bf43b1a62968838a">dr_register_signal_event()</a>)</li>
<li>Kernel-mediated control transfers (<a class="el" href="dr__events_8h.html#ac433abf2a9b5ec9a5571e39d7d069df2">dr_register_kernel_xfer_event()</a>):<ul>
<li>Application APC (Asynchronous Procedure Call), callback, or exception dispatcher execution (Windows)</li>
<li>Application signal delivery (Linux)</li>
<li>System call that changes the context</li>
</ul>
</li>
<li>System call interception: pre-system call, post-system call, and system call filtering by number (<a class="el" href="dr__events_8h.html#a80d0f026def74d903a83fb6122816ae2">dr_register_pre_syscall_event()</a>, <a class="el" href="dr__events_8h.html#a7a62b6c11f3b0ae2fe7773189f6e4826">dr_register_post_syscall_event()</a>, <a class="el" href="dr__events_8h.html#a1f98fd4c247abe6c7fcc6d02291b44de">dr_register_filter_syscall_event()</a>)</li>
<li>Signal interception (Linux-only) (<a class="el" href="dr__events_8h.html#a8f0c200ef1c92ac8bf43b1a62968838a">dr_register_signal_event()</a>)</li>
<li>Nudge received - see <a class="el" href="using.html#sec_comm">Communication</a> (<a class="el" href="dr__events_8h.html#a03da807cdb97ec8d0db68b6d24974ea4">dr_register_nudge_event()</a>)</li>
</ul>
<p>Typically, a client will register for the desired events at initialization in its <a class="el" href="dr__api_8h.html#a2b938c98dd186cc94eef6880f9e3c3e9">dr_client_main()</a> routine. DynamoRIO then calls the registered functions at the appropriate times. Each event has a specific registration routine (e.g., <a class="el" href="dr__events_8h.html#a92ad96993c826232e76a56ff43cd31d0">dr_register_thread_init_event()</a>: see the names in parentheses in the list above) and an associated unregistration routine. The header file <a class="el" href="dr__events_8h.html" title="Event callback registration routines.">dr_events.h</a> contains the declarations for all registration and unregistration routines.</p>
<p>Note that clients are allowed to register multiple callbacks for the same event. DynamoRIO also supports mutiple clients, each of which can register for the same event. In this case, DynamoRIO sequences event callbacks in reverse order of when they were registered. In other words, the first registered callback receives event notification last. This scheme gives priority to a callback registered earlier, since it can override or modify the actions of clients registered later. Note that DynamoRIO calls each client's <a class="el" href="dr__api_8h.html#a2b938c98dd186cc94eef6880f9e3c3e9">dr_client_main()</a> routine according to the client's priority (see <a class="el" href="page_deploy.html#multi_client">Multiple Clients</a> and <a class="el" href="dr__config_8h.html#ae9e35bfc0682dd3bee71eb8992d9eca3">dr_register_client()</a> in the deployment API).</p>
<p>Systems registering multiple callbacks for a single event should be aware that client modifications are visible in subsequent callbacks. DynamoRIO makes no attempt to mitigate interference among callback functions. It is the responsibility of a client to ensure compatibility among its callback functions and the callback functions of other clients.</p>
<p>Clients can also unregister a callback using the appropriate unregister routine (see <a class="el" href="dr__events_8h.html" title="Event callback registration routines.">dr_events.h</a>). While unusual, it is possible for one callback routine to unregister another. In this case, DynamoRIO still calls routines that were registered before the event. Unregistration takes effect before the next event.</p>
<p>On Linux, an exec (SYS_execve) does NOT result in an exit event, but it WILL result in the client library being reloaded and its <a class="el" href="dr__api_8h.html#a2b938c98dd186cc94eef6880f9e3c3e9">dr_client_main()</a> routine being called again. The system call events can be used for notification of SYS_execve.</p>
<h1><a class="anchor" id="sec_utils"></a>
Common Utilities</h1>
<p>DynamoRIO provides clients with a powerful library of utilities for custom runtime code transformations. The interface includes explicit support for creating <em>transparent</em> clients. See the section on <a class="el" href="transparency.html">Client Transparency</a> for a full discussion of the importance of remaining transparent when operating in the same process as the application. DynamoRIO provides common resources clients can use to avoid reliance on shared libraries that may be in use by the application. The client should only use external resources through DynamoRIO's own API, through DynamoRIO Extensions (see <a class="el" href="using.html#sec_extensions">DynamoRIO Extension Libraries</a>), through direct system calls, or via an external agent in a separate process that communicates with the client (see <a class="el" href="using.html#sec_comm">Communication</a>). Third-party libraries can be used if they are linked statically or loaded privately and there is no possibility of global resource conflicts (e.g., a third-party library's memory allocation must be wrapped): see <a class="el" href="using.html#sec_extlibs">Using External Libraries</a> for more details.</p>
<p>DynamoRIO's API provides:</p>
<ul>
<li>Memory allocation: both thread-private (faster as it incurs no synchronization costs) and thread-shared</li>
<li>Thread-local storage</li>
<li>Thread-local stack separate from the application stack</li>
<li>Simple mutexes</li>
<li>File creation, reading, and writing</li>
<li>Address space querying</li>
<li>Application module iterator</li>
<li>Processor feature identification</li>
<li>Extra thread creation</li>
<li>Symbol lookup (currently Windows-only)</li>
<li>Auxiliary library loading</li>
</ul>
<p>See <a class="el" href="dr__tools_8h.html" title="Main API routines, including transparency support.">dr_tools.h</a> and <a class="el" href="dr__proc_8h.html" title="Utility routines for identifying features of the processor.">dr_proc.h</a> for specifics of each routine.</p>
<p>Another class of utilities provided by DynamoRIO are structures and routines for decoding, encoding, and manipulating IA-32, AMD64, ARM, and AArch64 instructions. These are described in <a class="el" href="API_BT.html#sec_IR">Instruction Representation</a>.</p>
<p><a class="anchor" id="subsec_forwards"></a>In addition, on Windows, DynamoRIO provides a number of utility functions that it fowards to a core Windows system library that we believe to be safe for clients to use:</p>
<ul>
<li>wcstoul</li>
<li>wcstombs</li>
<li>wcstol</li>
<li>wcsstr</li>
<li>wcsspn</li>
<li>wcsrchr</li>
<li>wcspbrk</li>
<li>wcsncpy</li>
<li>wcsncmp</li>
<li>wcsncat</li>
<li>wcslen</li>
<li>wcscspn</li>
<li>wcscpy</li>
<li>wcscmp</li>
<li>wcschr</li>
<li>wcscat</li>
<li>towupper</li>
<li>towlower</li>
<li>toupper</li>
<li>tolower</li>
<li>tan</li>
<li>strtoul</li>
<li>strtol</li>
<li>strstr</li>
<li>strspn</li>
<li>strrchr</li>
<li>strpbrk</li>
<li>strncpy</li>
<li>strncmp</li>
<li>strncat</li>
<li>strlen</li>
<li>strcspn</li>
<li>strcmp</li>
<li>strchr</li>
<li>sscanf</li>
<li>sqrt</li>
<li>sprintf</li>
<li>sin</li>
<li>qsort</li>
<li>pow</li>
<li>memset</li>
<li>memmove</li>
<li>memcpy</li>
<li>memcmp</li>
<li>memchr</li>
<li>mbstowcs</li>
<li>log</li>
<li>labs</li>
<li>isxdigit</li>
<li>iswxdigit</li>
<li>iswspace</li>
<li>iswlower</li>
<li>iswdigit</li>
<li>iswctype</li>
<li>iswalpha</li>
<li>isupper</li>
<li>isspace</li>
<li>ispunct</li>
<li>isprint</li>
<li>islower</li>
<li>isgraph</li>
<li>isdigit</li>
<li>iscntrl</li>
<li>isalpha</li>
<li>isalnum</li>
<li>floor</li>
<li>fabs</li>
<li>cos</li>
<li>ceil</li>
<li>atol</li>
<li>atoi</li>
<li>atan</li>
<li>abs</li>
<li>_wtol</li>
<li>_wtoi64</li>
<li>_wtoi</li>
<li>_wcsupr</li>
<li>_wcsnicmp</li>
<li>_wcslwr</li>
<li>_wcsicmp</li>
<li>_vsnprintf</li>
<li>_ultow</li>
<li>_ultoa</li>
<li>_ui64toa</li>
<li>_toupper</li>
<li>_tolower</li>
<li>_strupr</li>
<li>_strnicmp</li>
<li>_strlwr</li>
<li>_stricmp</li>
<li>_strcmpi</li>
<li>_snwprintf</li>
<li>_snprintf</li>
<li>_memicmp</li>
<li>_memccpy</li>
<li>_ltow</li>
<li>_ltoa</li>
<li>_itow</li>
<li>_itoa</li>
<li>_i64tow</li>
<li>_i64toa</li>
<li>_ftol</li>
<li>_fltused</li>
<li>_chkstk</li>
<li>_aullshr</li>
<li>_aullrem</li>
<li>_aulldiv</li>
<li>_atoi64</li>
<li>_allshr</li>
<li>_allshl</li>
<li>_allrem</li>
<li>_allmul</li>
<li>_alldiv</li>
<li>__toascii</li>
<li>__iscsymf</li>
<li>__iscsym</li>
<li>__isascii</li>
</ul>
<p>In general, these routines match their standard C library counterparts. However, be warned that some of these may be more limited. In particular, _vsnprintf and _snprintf do not support floating-point values. DynamoRIO provides its own <a class="el" href="dr__tools_8h.html#a07fe87f7bf9560a45751064329bc8c12">dr_snprintf()</a> that does support floating-point values, but does not support printing wide characters. When printing floating-point values be sure to <a class="el" href="transparency.html#sec_trans_floating_point">save the application's floating point state</a> so as to avoid corrupting it.</p>
<h1><a class="anchor" id="sec_64bit_reach"></a>
64-Bit Reachability</h1>
<p>To simplify reachability in a 64-bit address space, DynamoRIO guarantees that all of its code caches are located within a single 2GB memory region. It also places all client memory allocated through <a class="el" href="dr__tools_8h.html#a18d391b20559c1737c795f2ef1ba33d2">dr_thread_alloc()</a>, <a class="el" href="dr__tools_8h.html#a82f6546fc3e259e64493aeda5a8f1c86">dr_global_alloc()</a>, <a class="el" href="dr__tools_8h.html#a917384359d5efd538976402ff4b08aae">dr_nonheap_alloc()</a>, or <a class="el" href="dr__tools_8h.html#a527e0746207909580b705f1743537921">dr_custom_alloc()</a> with <a class="el" href="dr__tools_8h.html#abb7e20e83f7b8e1b65428e45c8ab4211ab33a2e990410bf314bdebe6a25aa06e1">DR_ALLOC_CACHE_REACHABLE</a> in the same region.</p>
<p>DynamoRIO loads client libraries and Extensions (but not copies of system libraries) within 32-bit reachability of its code caches. Typically, the code cache region is located in the low 4GB of the address space; thus, to avoid relocations at client library load time, it is recommended to set a preferred client library base in the low 4GB. The <a class="el" href="page_deploy.html#op_reachable_client">-reachable_client runtime option</a> can be used to remove this guarantee. The option is automatically turned off when DynamoRIO and clients are statically linked with the application: for such static usage, 32-bit reachability to the code cache by clients is not guaranteed.</p>
<p>The net result is that any static data or code in a client library, or any data allocated using DynamoRIO's API routines (except <a class="el" href="dr__tools_8h.html#a2a5b61c462fe7d4c5f5b78f76a6eedce">dr_raw_mem_alloc()</a> or <a class="el" href="dr__tools_8h.html#a527e0746207909580b705f1743537921">dr_custom_alloc()</a>), is guaranteed to be directly reachable from code cache code. However, memory allocated through system libraries (including malloc, operator new, and HeapAlloc), as well as DynamoRIO's own internally-used heap memory, is <em>not</em> guaranteed to be reachable: only memory directly allocated via DynamoRIO's API. The <a class="el" href="page_deploy.html#op_reachable_heap">-reachable_heap runtime option</a> can be used to guarantee that all memory is reachable, at the risk of running out of memory due to the smaller space of available memory.</p>
<p>To make more space available for the code caches when running larger applications, or for clients that use a lot of heap memory that is not directly referenced from the cache, we recommend that <a class="el" href="dr__tools_8h.html#a527e0746207909580b705f1743537921">dr_custom_alloc()</a> be called to obtain memory that is not guaranteed to be reachable from the code cache (by not passing <a class="el" href="dr__tools_8h.html#abb7e20e83f7b8e1b65428e45c8ab4211ab33a2e990410bf314bdebe6a25aa06e1">DR_ALLOC_CACHE_REACHABLE</a>). This frees up space in the reachable region.</p>
<p>When inserting calls, <a class="el" href="dr__ir__utils_8h.html#a0258cfa82416ee2ba40ed73e4d4eebf7">dr_insert_call()</a> and <a class="el" href="dr__ir__utils_8h.html#a1df44dbe3d8dbf82e63e96741f167c64">dr_insert_clean_call()</a> assume that the call is destined for encoding into the code cache-reachable memory region, when determining whether a direct or indirect call is needed. An indirect call will clobber r11. Use <a class="el" href="dr__ir__utils_8h.html#a175c7c2531aa70017d2fb020f93e374f">dr_insert_clean_call_ex()</a> with <a class="el" href="dr__defines_8h.html#af1b1bc23c42ffb7452568176b09b1212a9fe53fc77afb460ba31666995df5b6c9">DR_CLEANCALL_INDIRECT</a> to ensure reachability when encoding to a location other than DR's regular code region, or when a clean call is not needed, <a class="el" href="dr__ir__utils_8h.html#a4640c7ef1edbf0358ba3b315ec12fb64">dr_insert_call_ex()</a> takes in a target encode location for more flexible determination of direct versus indirect.</p>
<p>DynamoRIO does not guarantee that any of its memory is allocated in the lower 4GB of the address space. However, it provides several features to make it easier to reference addresses absolutely:</p>
<ul>
<li>For directly referencing a global variable <code>var</code> in a client library, the client can create an operand with the address <code>&amp;var</code> and it will auto-magically turn into a pc-relative addressing mode. <a class="el" href="dr__ir__macros__aarch64_8h.html#a54b8bd667a8a940e94bfcc7842c958eb">OPND_CREATE_ABSMEM()</a> directly creates a pc-relative operand, while <a class="el" href="dr__ir__opnd_8h.html#ab73fb113359aaee37844b2592917598d">opnd_create_abs_addr()</a> will convert to a pc-relative operand when an absolute reference will not encode. An <a class="el" href="dr__ir__opnd_8h.html#a6d1d3033c01b8dc8cadc3dd84e8b983e">opnd_create_rel_addr()</a> operand will also convert to an absolute reference when that will reach but a pc-relative reference will not.</li>
<li>When using an address as an immediate, use the routines <a class="el" href="dr__ir__utils_8h.html#a303cc7b7b132b9aafb8db5abae76d45f">instrlist_insert_mov_immed_ptrsz()</a> or <a class="el" href="dr__ir__utils_8h.html#abf2861316d8857d190ac174b58c18544">instrlist_insert_push_immed_ptrsz()</a> to conveniently insert either one or two instructions depending on whether the address is in the lower 4GB or not.</li>
<li>When using an <a class="el" href="structinstr__t.html">instr_t</a> pointer as an immediate, use the routines <a class="el" href="dr__ir__utils_8h.html#a18a42d59b54c1f768a0f8ef0c0e91c34">instrlist_insert_mov_instr_addr()</a> or <a class="el" href="dr__ir__utils_8h.html#a2315a34a23b75cbaebfc97e6547b5d10">instrlist_insert_push_instr_addr()</a> to conveniently insert either one or two instructions depending on whether the resulting <a class="el" href="structinstr__t.html">instr_t</a> encoded address is in the lower 4GB or not.</li>
</ul>
<h1><a class="anchor" id="sec_utf8"></a>
String Encoding</h1>
<p>All strings in the DynamoRIO API, whether input or output parameters, are encoded as UTF-8. DynamoRIO will internally convert to UTF-16 when interacting with the Windows kernel. A client can use <a class="el" href="dr__tools_8h.html#a07fe87f7bf9560a45751064329bc8c12">dr_snprintf()</a> or <a class="el" href="dr__tools_8h.html#a6dca11e2920892d292405c49695d4890">dr_snwprintf()</a> with the <code>S</code> format code to convert between UTF-8 and UTF-16 on its own. (The _snprintf() function forwarded to ntdll does not perform that conversion.)</p>
<h1><a class="anchor" id="sec_extensions"></a>
DynamoRIO Extension Libraries</h1>
<p>DynamoRIO supports extending the API presented to clients through separate libraries called DynamoRIO Extensions. Extensions are meant to include features that may be too costly to make available by default or features contributed by third parties whose licensing requires using a separate library. Extensions can be either static libraries linked with clients at build time or dynamic libraries loaded at runtime. A private loader is used to load dynamic Extensions.</p>
<p>Current Extensions provide symbol access and container data structures. Each Extension has its own documentation and has its functions and data structures documented separately from the main API. See the full list of Extensions here: <a class="el" href="page_ext.html">Extension API</a>.</p>
<p>Be aware that some of the DynamoRIO Extensions have LGPL licenses instead of the BSD license of the rest of DynamoRIO. Such Extensions are built as shared libraries, have their own license.txt files, and clearly identify their license in their documentation. (We also provide static versions of such libraries, but take care in using them that their LGPL licenses match your requirements.)</p>
<h1><a class="anchor" id="sec_extlibs"></a>
Using External Libraries</h1>
<p>Clients are free to use external libraries as long as those libraries do not use any global user-mode resources that would interfere with the running application, and as long as no alertable system calls are invoked on Windows (see <a class="el" href="using.html#sec_alertable">Avoid Alertable System Calls</a>). While most non-graphical non-alertable Windows API routines are supported, native threading libraries such as <code>libpthread.so</code> on Linux are known to cause problems.</p>
<p>Currently we provide a private loader for both Windows and Linux which supplies support for client external library use. Clients must either link statically to all libraries or load them using our private loader, which will happen automatically for shared libraries loaded in a typical manner. With private loading, the client uses a separate copy of each library from any copy used by the application. This helps to prevent re-entrancy problems (see <a class="el" href="transparency.html#sec_trans_resource">Resource Usage Conflicts</a>). Even with this separation, if these libraries use global resources there can still be conflicts. Our private loader redirects heap allocation in the main process heap to instead use DynamoRIO's internal heap. The loader also attempts to isolate other global resource usage and global callbacks. Please file reports on any transparency problems observed when using the private loader.</p>
<p>By default, all Windows clients link with libc. To instead use the libc subset of routines forwarded from the DynamoRIO library to <code>ntdll.dll</code> (which keeps clients more lightweight and is usually sufficient for most C code), set this variable prior to invoking configure_DynamoRIO_client():</p>
<div class="fragment"><div class="line">set(DynamoRIO_USE_LIBC OFF)</div>
</div><!-- fragment --><p>C++ clients and standalone clients link with libc by default.</p>
<h2><a class="anchor" id="sec_alertable"></a>
Avoid Alertable System Calls</h2>
<p>On Windows, DynamoRIO does not support a client (or a library used by a client) making alertable system calls. These are system calls that can be interrupted for delivery of callbacks or asynchronous procedure calls. At the Windows API layer, they include many graphical routines, any Wait function invoked with <code>alertable=TRUE</code> (e.g., WaitForSingleObjectEx or WaitForMultipleObjectsEx), any Windows message queue function (GetMessage, SendMessage, ReplyMessage), and asynchronous i/o. In general, avoiding graphical, windowing, or asynchronous i/o library or system calls is advisable. DynamoRIO does not guarantee correct execution when a callback arrives during client code execution.</p>
<h2><a class="anchor" id="sec_rpath"></a>
DynamoRIO Library Search Paths</h2>
<p>DynamoRIO's loader searches for libraries in approximately the same manner as the system loader. It also has support for automatically locating Extension libraries that are packaged in the usual place in the DynamoRIO file hierarchy.</p>
<p>DynamoRIO supports setting DT_RPATH for ELF clients, via setting the DynamoRIO_RPATH variable to ON prior to invoking configure_DynamoRIO_client(). On Windows, setting that variable will create a "&lt;client_basename&gt;.drpath" text file that contains a list of paths. At runtime, DynamoRIO's loader will parse this file and add each newline-separated path to its list of search paths. This file is honored on Linux as well, though it is not automatically created there. This allows clients a cross-platform mechanism to use third-party libraries in locations of their choosing.</p>
<h2><a class="anchor" id="subsec_avoid_redir"></a>
Deliberately Invoking Application Routines</h2>
<p>Sometimes, a client wishes to invoke system library routines with the application context, rather than having them redirected and isolated by DynamoRIO. This can be accomplished using dynamic binding rather than static: dynamically looking up each desired library routine via DR's own routines (such as <a class="el" href="dr__modules_8h.html#acb571b80307fd90538cb006725ab6183">dr_get_proc_address()</a>). (Using <code>GetProcAddress</code> will not work for this purpose as the result will be redirected.)</p>
<h2><a class="anchor" id="subsec_no_loader"></a>
When Private Loader is Disabled</h2>
<p>On Linux, if the private loader is deliberately disabled, ld provides the -wrap option, which allows us to override the C library's memory heap allocation routines with our own. For convenience, DynamoRIO exports <a class="el" href="dr__tools_8h.html#a26eb3354bab05483603b96774149aa2e">__wrap_malloc()</a>, <a class="el" href="dr__tools_8h.html#a308b0cde282bb6ad04b413a743ec2675">__wrap_realloc()</a>, and <a class="el" href="dr__tools_8h.html#a4640fe5eadb1d6cb384f61524886211d">__wrap_free()</a> for this purpose. These routines behave like their C library counterparts, but operate on DynamoRIO's global memory pool. Use the -Xlinker flag with gcc to replace the libc routines with DynamoRIO's _wrap routines, e.g.,</p>
<div class="fragment"><div class="line">gcc -Xlinker -wrap=malloc -Xlinker -wrap=realloc -Xlinker -wrap=free -Xlinker -wrap=strdup ...</div>
</div><!-- fragment --><p>The ability to override the memory allocation routines makes it convenient to develop C++ clients that use the <em>new</em> and <em>delete</em> operators (as long as those operators are implemented using malloc and free). In particular, heap allocation is required to use the C++ Standard Template Library containers. When developing a C++ client, we recommend linking statically to the C++ runtime library if not using the provided private loader.</p>
<p>On Linux, this is most easily accomplished by specifying the path to the static version of the library on the gcc command line. gcc's -print-file-name option is useful for discovering this path, e.g.,</p>
<div class="fragment"><div class="line">g++ -print-file-name=libstdc++.a</div>
</div><!-- fragment --><p>A full gcc command line for building a C++ client when disabling the private loader (which is not the default) might look something like this (note that this requires static versions of the standard libraries that were built PIC, which is not the case in modern binary distributions and often requires building from source):</p>
<div class="fragment"><div class="line">g++ -o my-client.so -I&lt;header dir&gt; \</div>
<div class="line">  -fPIC -shared -nodefaultlibs \</div>
<div class="line">  -Xlinker -wrap=malloc -Xlinker -wrap=realloc -Xlinker -wrap=free \</div>
<div class="line">  `g++ -print-file-name=libstdc++.a` \</div>
<div class="line">  `g++ -print-file-name=libgcc.a` \</div>
<div class="line">  `g++ -print-file-name=libgcc_eh.a` \</div>
<div class="line">  my-client.cpp</div>
</div><!-- fragment --><h2><a class="anchor" id="subsec_cpp"></a>
C++ Clients</h2>
<p>The 3.0 version of DynamoRIO added experimental full support for C++ clients using the STL and other libraries.</p>
<p>On Windows, when using the Microsoft Visual C++ compiler, we recommend using the <code>/MT</code> compiler flag to request a static C library. The client will still use the <code>kernel32.dll</code> library but our private loader will load a separate copy of that library and redirect heap allocation automatically. Our private loader does not yet support locating SxS (side-by-side) libraries, so using <code>/MD</code> will most likely not work unless using a version of the Visual Studio compiler other than 2005 or 2008.</p>
<p>We do not recommend that a client or its libraries invoke their own system calls as this bypasses DynamoRIO's monitoring of changes to the process address space and changes to threads or control flow. Such system calls will also not work properly on Linux when using sysenter on some systems. If you see an assert to that effect in debug build on Linux, try the <a class="el" href="page_deploy.html#op_sysenter">-sysenter_is_int80</a> option.</p>
<h1><a class="anchor" id="sec_comm"></a>
Communication</h1>
<p>Due to transparency limitations (see <a class="el" href="transparency.html">Client Transparency</a>), DynamoRIO can only support certain communication channels in and out of the target application process. These include:</p>
<ul>
<li>DynamoRIO deployment control and runtime options: see <a class="el" href="page_deploy.html">How to Run</a> and <a class="el" href="page_deploy.html#sec_options">DynamoRIO Runtime Options</a>. In particular, the deployment API allows users to pass up-front runtime information to the client.</li>
<li>Nudges: Since polling requires extra threads, and DynamoRIO tries not to create permanent extra threads (see <a class="el" href="transparency.html#sec_trans_thread">Thread Transparency</a>), a mechanism called <em>nudges</em> are the preferred mechanism for pushing data into the process. Nudges are used to notify DynamoRIO that it needs to re-read its options, or perform some other action. DynamoRIO also provides a custom nudge event that can be used by clients. See <a class="el" href="dr__config_8h.html#a9df3d364222898cebc24264a161e2a5f">dr_nudge_process()</a> and <a class="el" href="dr__events_8h.html#a03da807cdb97ec8d0db68b6d24974ea4">dr_register_nudge_event()</a>.</li>
<li>Files can be used to send data out. An external process can wait on the file.</li>
<li>Shared memory can be used for bi-directional communication. For an example of this on Windows, see the stats sample (see <a class="el" href="API_samples.html#sec_drstats">Use of Custom Client Statistics with the Windows GUI</a>).</li>
</ul>
<h1><a class="anchor" id="sec_annotations"></a>
Annotations</h1>
<p>DynamoRIO provides a binary annotation mechanism which allows the target application to communicate directly with the DynamoRIO client, or with DynamoRIO itself. A binary annotation is generated from a macro that can be manually inserted into the source code of the target program. When compiled, the resulting sequence of assembly instructions has no effect on native execution (i.e., it is a nop, or resolves to a static default value), but during execution under DynamoRIO, each annotation is detected and transformed into a function call to a set of registered handlers. Currently DynamoRIO provides 2 simple annotations:</p>
<ul>
<li><b>DYNAMORIO_ANNOTATE_RUNNING_ON_DYNAMORIO()</b> Indicates by its return value whether the target app is running under DynamoRIO,</li>
<li><b>DYNAMORIO_ANNOTATE_LOG(format, ...)</b> Writes a message to the DynamoRIO log, when the target app is running under DynamoRIO and logging is enabled.</li>
</ul>
<p>An annotation may be declared void, as in DYNAMORIO_ANNOTATE_LOG(), or it may have a return value, as in the boolean DYNAMORIO_ANNOTATE_RUNNING_ON_DYNAMORIO(). The return value can be used in a branch predicate, such that some of the target app's code only executes under DynamoRIO, or it can be used for in-process communication to obtain data from DynamoRIO or its client that is only available during binary translation.</p>
<h2><a class="anchor" id="subsec_annotate_app"></a>
Annotating an Application</h2>
<p>Adding an annotation to a target application is primarily a simple matter of invoking the annotation macro at the desired program location. The macros are declared in the C header file <b>include/annotations/dr_annotations.h</b>, and each macro operates syntactically like a function call. An annotation having a return value can be used as an expression. DynamoRIO provides a module which defines the annotations, and clients may also provide modules containing custom annotations. Each compilation unit that uses annotations must be statically linked with the corresponding annotation module(s). For projects using cmake, a convenience function <b>use_DynamoRIO_annotations(target, srcs)</b> will configure the specified <b>srcs</b> to be linked with the annotation module.</p>
<h2><a class="anchor" id="subsec_instr_annotations"></a>
Instrumenting Annotations</h2>
<p>When DynamoRIO encounters an annotation in the target app, it instruments that program location in one of two ways:</p>
<ul>
<li>Return value substitution: DynamoRIO replaces the annotation with a constant return value (this instrumentation is only valid for annotations having a return value),</li>
<li>Handler invocation: DynamoRIO replaces the annotation with a call to each handler that is currently registered for the annotation. For annotations having a return value, the return value of the last registered handler will be the value to take effect at the target program location.</li>
</ul>
<p>Annotation handlers are registered using API functions <b><a class="el" href="dr__annotation_8h.html#a65cd22eacefdcd5c534a1b4aa72ae103">dr_annotation_register_call()</a></b> and <b><a class="el" href="dr__annotation_8h.html#a8e6f07b0e6d56086b086b9d9e565f63a">dr_annotation_register_return()</a></b>. Note that changes to handler registration will have no effect on annotations that have already been translated by DynamoRIO into the code cache (until the annotated basic blocks are removed from the cache and retranslated). The annotation instrumentation invokes the handlers using a separate clean call for each handler. The return value for an annotation can be set within a handler function using the API function <b><a class="el" href="dr__annotation_8h.html#ab32f294e5bfa81b8464dc8bc0e0d4d3e">dr_annotation_set_return_value()</a></b>.</p>
<h2><a class="anchor" id="subsec_create_annotations"></a>
Creating Custom Annotations</h2>
<p>DynamoRIO client developers may wish to create new annotations to facilitate client-specific communication with the target application. For example, a client that inspects memory usage may have false positives for variables in the target app that are never referenced after initialization. The <a class="el" href="API_tutorial_annotation1.html">create_annotation</a> walks through the process of creating a new annotation that allows target application developers to explicitly mark any variable as defined. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:04:09 &nbsp; <img border=0 src="favicon.png">
</small></address>
<!--END !GENERATE_TREEVIEW-->
</body>
</html>
