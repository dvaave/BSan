---
title: "Instrumentation Utilities"
layout: default
permalink: /group__drutil.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Instrumentation Utilities</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gae2b7cca016411251a1dbebc5dbefa4f1"><td class="memItemLeft" align="right" valign="top">DR_EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#gae2b7cca016411251a1dbebc5dbefa4f1">drutil_init</a> (void)</td></tr>
<tr class="separator:gae2b7cca016411251a1dbebc5dbefa4f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa18c356df47853e7f0258feced9dd885"><td class="memItemLeft" align="right" valign="top">DR_EXPORT void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#gaa18c356df47853e7f0258feced9dd885">drutil_exit</a> (void)</td></tr>
<tr class="separator:gaa18c356df47853e7f0258feced9dd885"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2f53127090ac749d0c17713f0eb25571"><td class="memItemLeft" align="right" valign="top">DR_EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#ga2f53127090ac749d0c17713f0eb25571">drutil_insert_get_mem_addr</a> (void *drcontext, <a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *bb, <a class="el" href="structinstr__t.html">instr_t</a> *where, <a class="el" href="structopnd__t.html">opnd_t</a> memref, <a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a> dst, <a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a> scratch)</td></tr>
<tr class="separator:ga2f53127090ac749d0c17713f0eb25571"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae798d2a61656f716a250996171c8cff8"><td class="memItemLeft" align="right" valign="top">DR_EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#gae798d2a61656f716a250996171c8cff8">drutil_insert_get_mem_addr_ex</a> (void *drcontext, <a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *bb, <a class="el" href="structinstr__t.html">instr_t</a> *where, <a class="el" href="structopnd__t.html">opnd_t</a> memref, <a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a> dst, <a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a> scratch, OUT bool *scratch_used)</td></tr>
<tr class="separator:gae798d2a61656f716a250996171c8cff8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga7e3d7896921f5bc20dd70d0de666ce6f"><td class="memItemLeft" align="right" valign="top">DR_EXPORT uint&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#ga7e3d7896921f5bc20dd70d0de666ce6f">drutil_opnd_mem_size_in_bytes</a> (<a class="el" href="structopnd__t.html">opnd_t</a> memref, <a class="el" href="structinstr__t.html">instr_t</a> *inst)</td></tr>
<tr class="separator:ga7e3d7896921f5bc20dd70d0de666ce6f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae38961d42fc285d7f9034c4b02690cae"><td class="memItemLeft" align="right" valign="top">DR_EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#gae38961d42fc285d7f9034c4b02690cae">drutil_expand_rep_string</a> (void *drcontext, <a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *bb)</td></tr>
<tr class="separator:gae38961d42fc285d7f9034c4b02690cae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab75e6f41cd4ee5afaec592725abe1557"><td class="memItemLeft" align="right" valign="top">DR_EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#gab75e6f41cd4ee5afaec592725abe1557">drutil_expand_rep_string_ex</a> (void *drcontext, <a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *bb, OUT bool *expanded, OUT <a class="el" href="structinstr__t.html">instr_t</a> **stringop)</td></tr>
<tr class="separator:gab75e6f41cd4ee5afaec592725abe1557"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga03209b5a9c85fff6402ceeb90f9995f3"><td class="memItemLeft" align="right" valign="top">DR_EXPORT bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__drutil.html#ga03209b5a9c85fff6402ceeb90f9995f3">drutil_instr_is_stringop_loop</a> (<a class="el" href="structinstr__t.html">instr_t</a> *inst)</td></tr>
<tr class="separator:ga03209b5a9c85fff6402ceeb90f9995f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h2 class="groupheader">Function Documentation</h2>
<a id="gaa18c356df47853e7f0258feced9dd885"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa18c356df47853e7f0258feced9dd885">&#9670;&nbsp;</a></span>drutil_exit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT void drutil_exit </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Cleans up the drutil extension. </p>

</div>
</div>
<a id="gae38961d42fc285d7f9034c4b02690cae"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae38961d42fc285d7f9034c4b02690cae">&#9670;&nbsp;</a></span>drutil_expand_rep_string()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT bool drutil_expand_rep_string </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>drcontext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *&#160;</td>
          <td class="paramname"><em>bb</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Expands single-instruction string loops (those using the <code>rep</code> or <code>repne</code> prefixes) into regular loops to simplify memory usage analysis. This is accomplished by arranging for each single-instruction string loop to occupy a basic block by itself (by truncating the prior block before the loop, and truncating instructions after the loop) and then exanding it into a multi-instruction loop.</p>
<p>Clients applying this expansion are encouraged to use emulation-aware instrumentation via <a class="el" href="group__drmgr.html#gad375fb1c1a8683c54a78f4f5b9951f4a">drmgr_orig_app_instr_for_fetch()</a> and <a class="el" href="group__drmgr.html#ga6373ac13132abb039c7d0593bde073ba">drmgr_orig_app_instr_for_operands()</a> in order to observe the original string loop opcode with the expanded memory operands.</p>
<p>WARNING: The added multi-instruction loop contains several control-transfer instructions and is not straight-line code, which can complicate subsequent analysis routines.</p>
<p>WARNING: The added instructions have translations that are in the middle of the original string loop instruction. This is to prevent passes that match exact addresses from having multiple hits and doing something like inserting 6 clean calls.</p>
<p>WARNING: The added instructions include a jecxz instruction which will not be transformed into a 32-bit-reach instruction: thus, excessive added instrumentation may result in a reachability problem.</p>
<p>The client must use the <code>drmgr</code> Extension to order its instrumentation in order to use this function. This function must be called from the application-to-application ("app2app") stage (see <a class="el" href="group__drmgr.html#gae270eeb1ab24d4e05f8588b23822f45c">drmgr_register_bb_app2app_event()</a>).</p>
<p>This transformation is deterministic, so the caller can return DR_EMIT_DEFAULT from its event.</p>
<dl class="section return"><dt>Returns</dt><dd>whether successful. </dd></dl>

</div>
</div>
<a id="gab75e6f41cd4ee5afaec592725abe1557"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gab75e6f41cd4ee5afaec592725abe1557">&#9670;&nbsp;</a></span>drutil_expand_rep_string_ex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT bool drutil_expand_rep_string_ex </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>drcontext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *&#160;</td>
          <td class="paramname"><em>bb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">OUT bool *&#160;</td>
          <td class="paramname"><em>expanded</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">OUT <a class="el" href="structinstr__t.html">instr_t</a> **&#160;</td>
          <td class="paramname"><em>stringop</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Identical to <a class="el" href="group__drutil.html#gae38961d42fc285d7f9034c4b02690cae">drutil_expand_rep_string()</a> but returns additional information.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">drcontext</td><td>The opaque context </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bb</td><td>Instruction list passed to the app2app event </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">expanded</td><td>Whether any expansion occurred </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">stringop</td><td>The string instruction in the expanded loop</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>whether successful. </dd></dl>

</div>
</div>
<a id="gae2b7cca016411251a1dbebc5dbefa4f1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae2b7cca016411251a1dbebc5dbefa4f1">&#9670;&nbsp;</a></span>drutil_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT bool drutil_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Initializes the drutil extension. Must be called prior to any of the other routines. Can be called multiple times (by separate components, normally) but each call must be paired with a corresponding call to <a class="el" href="group__drutil.html#gaa18c356df47853e7f0258feced9dd885">drutil_exit()</a>.</p>
<dl class="section return"><dt>Returns</dt><dd>whether successful. </dd></dl>

</div>
</div>
<a id="ga2f53127090ac749d0c17713f0eb25571"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga2f53127090ac749d0c17713f0eb25571">&#9670;&nbsp;</a></span>drutil_insert_get_mem_addr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT bool drutil_insert_get_mem_addr </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>drcontext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *&#160;</td>
          <td class="paramname"><em>bb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinstr__t.html">instr_t</a> *&#160;</td>
          <td class="paramname"><em>where</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structopnd__t.html">opnd_t</a>&#160;</td>
          <td class="paramname"><em>memref</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a>&#160;</td>
          <td class="paramname"><em>dst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a>&#160;</td>
          <td class="paramname"><em>scratch</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Inserts instructions prior to <code>where</code> in <code>bb</code> that determine and store the memory address referred to by <code>memref</code> into the register <code>dst</code>. May clobber the register <code>scratch</code>. Supports far memory references. For far memory references via DS and ES, we assume that the segment base is 0.</p>
<p>All registers used in <code>memref</code> must hold their original application values in order for the proper address to be computed into <code>dst</code>. The <code>dst</code> register may overlap with the registers used in <code>memref</code>. On ARM, <code>scratch</code> must be different from those used in <code>memref</code> (as well as from <code>dst</code>). On x86, <code>scratch</code> will not be used unless <code>memref</code> is a far reference that either uses <code>dst</code> or is a base-disp with both a base and an index, or <code>memref</code> is a reference in the <a class="el" href="dr__ir__opcodes__x86_8h.html#a726ca809ffd3d67ab4b8476646f26635a549371e1914c0af56d1c4cf07fb3f9bb">OP_xlat</a> instruction.</p>
<p>To obtain each memory address referenced in a single-instruction string loop, use <a class="el" href="group__drutil.html#gae38961d42fc285d7f9034c4b02690cae">drutil_expand_rep_string()</a> to transform such loops into regular loops containing (non-loop) string instructions.</p>
<dl class="section return"><dt>Returns</dt><dd>whether successful. </dd></dl>

</div>
</div>
<a id="gae798d2a61656f716a250996171c8cff8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae798d2a61656f716a250996171c8cff8">&#9670;&nbsp;</a></span>drutil_insert_get_mem_addr_ex()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT bool drutil_insert_get_mem_addr_ex </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>drcontext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__defines_8h.html#a3fb73c55def575ec5705577625491d66">instrlist_t</a> *&#160;</td>
          <td class="paramname"><em>bb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinstr__t.html">instr_t</a> *&#160;</td>
          <td class="paramname"><em>where</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structopnd__t.html">opnd_t</a>&#160;</td>
          <td class="paramname"><em>memref</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a>&#160;</td>
          <td class="paramname"><em>dst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="dr__ir__opnd_8h.html#a0ee0a856086c863d56ad515919e03136">reg_id_t</a>&#160;</td>
          <td class="paramname"><em>scratch</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">OUT bool *&#160;</td>
          <td class="paramname"><em>scratch_used</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Identical to <a class="el" href="group__drutil.html#ga2f53127090ac749d0c17713f0eb25571">drutil_insert_get_mem_addr()</a> except it returns in the optional OUT parameter <code>scratch_used</code> whether or not <code>scratch</code> was written to. </p>

</div>
</div>
<a id="ga03209b5a9c85fff6402ceeb90f9995f3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga03209b5a9c85fff6402ceeb90f9995f3">&#9670;&nbsp;</a></span>drutil_instr_is_stringop_loop()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT bool drutil_instr_is_stringop_loop </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structinstr__t.html">instr_t</a> *&#160;</td>
          <td class="paramname"><em>inst</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Returns whether the given instr is a stringop loop.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">inst</td><td>The instr to inspect.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>whether given instr is a stringop loop. </dd></dl>

</div>
</div>
<a id="ga7e3d7896921f5bc20dd70d0de666ce6f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga7e3d7896921f5bc20dd70d0de666ce6f">&#9670;&nbsp;</a></span>drutil_opnd_mem_size_in_bytes()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DR_EXPORT uint drutil_opnd_mem_size_in_bytes </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structopnd__t.html">opnd_t</a>&#160;</td>
          <td class="paramname"><em>memref</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structinstr__t.html">instr_t</a> *&#160;</td>
          <td class="paramname"><em>inst</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Returns the size of the memory reference <code>memref</code> in bytes. To handle OP_enter, requires the containing instruction <code>inst</code> to be passed in. For single-instruction string loops, returns the size referenced by each iteration.</p>
<p>If the instruction is part of the xsave family of instructions, this returns an incomplete computation of the xsave instruction's written xsave area's size. Specifically, it</p>
<ul>
<li>Ignores the user state mask components set in edx:eax, because they are dynamic values. The real output size of xsave depends on the instruction's user state mask AND the user state mask as supported by the CPU based on the XCR0 control register.</li>
<li>Ignores supervisor state component PT (enabled/disabled by user state component mask bit 8).</li>
<li>Ignores the user state component PKRU state (enabled/disabled by user state component mask bit 9).</li>
<li>Ignores the xsaveopt flavor of xsave.</li>
<li>Ignores the xsavec flavor of xsave (compacted format).</li>
</ul>
<p>It computes the expected size for the standard format of the x87 user state component (enabled/disabled by user state component mask bit 0), the SSE user state component (bit 1), the AVX user state component (bit 2), the MPX user state components (bit 2 and 3) and the AVX-512 user state component (bit 7). </p>

</div>
</div>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:04:14 &nbsp; <img border=0 src="favicon.png">
</small></address>
