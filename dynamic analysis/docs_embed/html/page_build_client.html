---
title: "How to Build a Tool"
layout: default
permalink: /page_build_client.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DynamoRIO
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">How to Build a Tool </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To use the DynamoRIO API, a tool, or "client" of DynamoRIO, should include the main DynamoRIO header file:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dr__api_8h.html">dr_api.h</a>&quot;</span></div>
</div><!-- fragment --><p>The client's target operating system and architecture must be specified by setting pre-processor defines before including the DynamoRIO header files. The appropriate library must then be linked with. The define choices are:</p>
<ol type="1">
<li><code>WINDOWS</code>, <code>LINUX</code>, or (coming soon) <code>MACOS</code> </li>
<li><code>X86_32</code>, <code>X86_64</code>, <code>ARM_32</code>, or <code>ARM_64</code> </li>
</ol>
<p>Currently we provide a private loader for both Windows and Linux. With private loading, clients use a separate copy of each library from any copy used by the application.</p>
<p>If the private loader is deliberately disabled, for transparency reasons (see <a class="el" href="transparency.html">Client Transparency</a>), clients should be self-contained and should not share libraries with the application. Without the private loader, 64-bit clients must take care to try and load themselves within reachable range of DynamoRIO's code caches by setting a preferred base address, although this may not always be honored by the system loader.</p>
<p>The DynamoRIO release supplies <a href="http://www.cmake.org">CMake</a> configuration files to facilitate building clients with the proper compiler and linker flags. CMake is a cross-platform build system that generates Makefiles or other development system project files. A <code>DynamoRIOConfig.cmake</code> configuration file, along with supporting files, is distributed in the <code>cmake/</code> directory.</p>
<p>In its <code>CMakeLists.txt</code> file, a client should first invoke a <code>find_package(DynamoRIO)</code> command. This can optionally take a version parameter. This adds DynamoRIO as an imported target. If found, the client should then invoke the <code>configure_DynamoRIO_client()</code> function in order to configure build settings. Here is an example:</p>
<div class="fragment"><div class="line">add_library(myclient SHARED myclient.c)</div>
<div class="line">find_package(DynamoRIO)</div>
<div class="line"><span class="keywordflow">if</span> (NOT DynamoRIO_FOUND)</div>
<div class="line">  message(FATAL_ERROR <span class="stringliteral">&quot;DynamoRIO package required to build&quot;</span>)</div>
<div class="line">endif(NOT DynamoRIO_FOUND)</div>
<div class="line">configure_DynamoRIO_client(myclient)</div>
</div><!-- fragment --><p>The <code>samples/CMakeLists.txt</code> file in the release package serves as another example. The top of <code>DynamoRIOConfig.cmake</code> contains detailed instructions as well.</p>
<p>When configuring, the <code>DynamoRIO_DIR</code> CMake variable can be passed in to identify the directory that contains the <code>DynamoRIOConfig.cmake</code> file. For example:</p>
<div class="fragment"><div class="line">mkdir ../build</div>
<div class="line">cd ../build</div>
<div class="line">cmake -DDynamoRIO_DIR=$DYNAMORIO_HOME/cmake ../myclient</div>
<div class="line">make</div>
</div><!-- fragment --><p>The compiler needs to be configured prior to invoking cmake. If using gcc with a non-default target platform, the <code>CFLAGS</code> and <code>CXXFLAGS</code> environment variables should be set prior to invoking cmake. For example, to configure a 32-bit client when gcc's default is 64-bit:</p>
<div class="fragment"><div class="line">mkdir ../build</div>
<div class="line">cd ../build</div>
<div class="line">CFLAGS=-m32 cmake -DDynamoRIO_DIR=$DYNAMORIO_HOME/cmake ../myclient</div>
<div class="line">make</div>
</div><!-- fragment --><p>Note that <code>CXXFLAGS</code> should be set instead for a C++ client, and both should be set when building both types of clients from the same configuration (e.g., <code>samples/CMakeLists.txt</code>).</p>
<p>To improve clean call performance (see <a class="el" href="API_BT.html#sec_clean_call">Clean Calls</a> and <a class="el" href="page_deploy.html#op_cleancall">-opt_cleancall</a>), we recommend high levels of optimization when building a client.</p>
<p>If a client is not using CMake, the appropriate compiler and linker flags can be gleaned from <code>DynamoRIOConfig.cmake</code>. One method is to invoke CMake to generate a Makefile and then build with <code>VERBOSE=1</code>. We also summarize here the key flags required for 32-bit clients for <code>gcc:</code> </p>
<div class="fragment"><div class="line">gcc -fPIC -shared -lgcc -DLINUX -DX86_32 -I$DYNAMORIO_HOME/include my-client.c</div>
</div><!-- fragment --><p>And for <code>cl:</code> </p>
<div class="fragment"><div class="line">cl my-client.c /I$DYNAMORIO_HOME/include /GS- /DWINDOWS /DX86_32</div>
<div class="line">   /link /libpath:$DYNAMORIO_HOME/bin dynamorio.lib /dll /out:my-client.dll</div>
</div><!-- fragment --><p>For a 64-bit client with <code>cl:</code> </p>
<div class="fragment"><div class="line">cl my-client.c /I$DYNAMORIO_HOME/include /GS- /DWINDOWS /DX86_64</div>
<div class="line">   /link /libpath:$DYNAMORIO_HOME/bin dynamorio.lib /dll /out:my-client.dll</div>
<div class="line">   /base:0x72000000 /fixed</div>
</div><!-- fragment --><p>For 64-bit Linux clients, setting the preferred base takes several steps. Refer to <code>DynamoRIOConfig.cmake</code> for details.</p>
<p>To make clean call sequences more likely to be optimized, it is recommended to compile the client with optimizations, <code>-O2</code> for gcc or <code>/O2</code> for cl. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="adr__api_8h_html"><div class="ttname"><a href="dr__api_8h.html">dr_api.h</a></div><div class="ttdoc">Top-level include file for DynamoRIO API.</div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  DynamoRIO version 9.0.1 --- Mon Feb 14 2022 19:04:14 &nbsp; <img border=0 src="favicon.png">
</small></address>
